<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultravox-Twilio Bridge Server</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header { 
            background: #2c3e50; 
            color: white; 
            padding: 20px; 
            text-align: center;
        }
        .status-panel { 
            padding: 20px; 
            border-bottom: 1px solid #eee;
        }
        .status { 
            padding: 15px; 
            border-radius: 8px; 
            font-weight: bold; 
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .status.connected { 
            background: linear-gradient(135deg, #4CAF50, #45a049); 
            color: white;
            animation: pulse 2s infinite;
        }
        .status.disconnected { 
            background: linear-gradient(135deg, #f44336, #d32f2f); 
            color: white;
        }
        .status.connecting { 
            background: linear-gradient(135deg, #ff9800, #f57c00); 
            color: white;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .connections { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px;
            margin-top: 15px;
        }
        .connection-item { 
            padding: 12px; 
            border-radius: 6px; 
            border: 2px solid #ddd;
            text-align: center;
            transition: all 0.3s ease;
        }
        .connection-item.active { 
            border-color: #4CAF50; 
            background: #f8fff8;
        }
        .log-panel { 
            padding: 20px;
        }
        .log-container { 
            height: 400px; 
            overflow-y: auto; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            padding: 15px; 
            background: #f9f9f9;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        .log-entry { 
            margin-bottom: 8px; 
            padding: 5px 8px;
            border-radius: 4px;
        }
        .log-info { background: #e3f2fd; border-left: 4px solid #2196F3; }
        .log-success { background: #e8f5e8; border-left: 4px solid #4CAF50; }
        .log-error { background: #ffebee; border-left: 4px solid #f44336; }
        .log-warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        .controls { 
            padding: 20px; 
            background: #f5f5f5; 
            text-align: center;
        }
        .btn { 
            padding: 12px 24px; 
            margin: 0 10px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ‰ Ultravox-Twilio Bridge Server</h1>
            <p>ì‹¤ì‹œê°„ ìŒì„± AI í†µí™”ë¥¼ ìœ„í•œ ì›¹ì†Œì¼“ ë¸Œë¦¿ì§€</p>
        </div>
        
        <div class="status-panel">
            <div id="mainStatus" class="status disconnected">
                ğŸ”´ ì„œë²„ ì´ˆê¸°í™” ì¤‘...
            </div>
            
            <div class="connections">
                <div id="pieSocketStatus" class="connection-item">
                    <strong>Pie Socket</strong><br>
                    <span id="pieSocketText">ì—°ê²° ëŒ€ê¸°</span>
                </div>
                <div id="ultravoxStatus" class="connection-item">
                    <strong>Ultravox</strong><br>
                    <span id="ultravoxText">ì—°ê²° ëŒ€ê¸°</span>
                </div>
                <div id="twilioStatus" class="connection-item">
                    <strong>Twilio</strong><br>
                    <span id="twilioText">ì—°ê²° ëŒ€ê¸°</span>
                </div>
            </div>
        </div>
        
        <div class="log-panel">
            <h3>ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div id="logContainer" class="log-container">
                <!-- ë¡œê·¸ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
        
        <div class="controls">
            <button id="reconnectBtn" class="btn btn-primary">ğŸ”„ ì¬ì—°ê²°</button>
            <button id="clearLogBtn" class="btn btn-success">ğŸ§¹ ë¡œê·¸ ì§€ìš°ê¸°</button>
            <button id="testBtn" class="btn btn-danger">ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let pieSocket = null;
        let ultravoxSocket = null;
        let twilioSocket = null;
        let connectionStates = {
            pieSocket: false,
            ultravox: false,
            twilio: false
        };

        // DOM ìš”ì†Œë“¤
        const elements = {
            mainStatus: document.getElementById('mainStatus'),
            pieSocketStatus: document.getElementById('pieSocketStatus'),
            ultravoxStatus: document.getElementById('ultravoxStatus'),
            twilioStatus: document.getElementById('twilioStatus'),
            pieSocketText: document.getElementById('pieSocketText'),
            ultravoxText: document.getElementById('ultravoxText'),
            twilioText: document.getElementById('twilioText'),
            logContainer: document.getElementById('logContainer'),
            reconnectBtn: document.getElementById('reconnectBtn'),
            clearLogBtn: document.getElementById('clearLogBtn'),
            testBtn: document.getElementById('testBtn')
        };

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleString('ko-KR');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            elements.logContainer.appendChild(logEntry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(service, connected, message = '') {
            connectionStates[service] = connected;
            
            const statusElement = elements[`${service}Status`];
            const textElement = elements[`${service}Text`];
            
            if (connected) {
                statusElement.classList.add('active');
                textElement.textContent = message || 'ì—°ê²°ë¨ âœ…';
            } else {
                statusElement.classList.remove('active');
                textElement.textContent = message || 'ì—°ê²° ëŠê¹€ âŒ';
            }
            
            updateMainStatus();
        }

        function updateMainStatus() {
            const connectedCount = Object.values(connectionStates).filter(Boolean).length;
            
            if (connectedCount === 0) {
                elements.mainStatus.className = 'status disconnected';
                elements.mainStatus.textContent = 'ğŸ”´ ëª¨ë“  ì—°ê²° ëŠê¹€';
            } else if (connectedCount === 3) {
                elements.mainStatus.className = 'status connected';
                elements.mainStatus.textContent = 'ğŸŸ¢ ëª¨ë“  ì—°ê²° ì™„ë£Œ - í†µí™” ì¤€ë¹„ë¨';
            } else {
                elements.mainStatus.className = 'status connecting';
                elements.mainStatus.textContent = `ğŸŸ¡ ë¶€ë¶„ ì—°ê²° (${connectedCount}/3)`;
            }
        }

 // ì˜¬ë°”ë¥¸ ì›¹ì†Œì¼“ ì—°ê²°
function initializePieSocket() {
    log('Pie Socket ì—°ê²° ì‹œì‘...', 'info');
    updateConnectionStatus('pieSocket', false, 'ì—°ê²° ì¤‘...');
    
    const wsUrl = `wss://s14927.nyc1.piesocket.com/v3/1?api_key=qXA06KzSmWOcwJLzvXZmVVugaoKdvvxIf2ibv2Ge&notify_self=1`;
    
    pieSocket = new WebSocket(wsUrl);
    
    pieSocket.onopen = function() {
        log('âœ… Pie Socket ì—°ê²° ì„±ê³µ', 'success');
        updateConnectionStatus('pieSocket', true);
    };
            
            pieSocket.onclose = function(event) {
                log(`âŒ Pie Socket ì—°ê²° ëŠê¹€ (ì½”ë“œ: ${event.code})`, 'error');
                updateConnectionStatus('pieSocket', false);
                
                // ìë™ ì¬ì—°ê²°
                setTimeout(() => {
                    log('Pie Socket ì¬ì—°ê²° ì‹œë„...', 'warning');
                    initializePieSocket();
                }, CONFIG.RECONNECT_INTERVAL);
            };
            
            pieSocket.onerror = function(error) {
                log(`âŒ Pie Socket ì˜¤ë¥˜: ${error}`, 'error');
                updateConnectionStatus('pieSocket', false, 'ì˜¤ë¥˜ ë°œìƒ');
            };
            
            pieSocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handlePieSocketMessage(data);
                } catch (error) {
                    log(`ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ${error.message}`, 'error');
                }
            };
        }

        // Pie Socket ë©”ì‹œì§€ ì²˜ë¦¬
        function handlePieSocketMessage(data) {
            log(`ğŸ“¨ Pie Socket ë©”ì‹œì§€: ${data.type}`, 'info');
            
            switch(data.type) {
                case 'call_initiated':
                    log('ğŸ”„ í†µí™” ì‹œì‘ ì‹ í˜¸ ë°›ìŒ', 'success');
                    if (data.ultravox_join_url) {
                        connectToUltravox(data.ultravox_join_url);
                    }
                    break;
                    
                case 'audio_from_twilio':
                    forwardAudioToUltravox(data.audioData);
                    break;
                    
                case 'audio_from_ultravox':
                    forwardAudioToTwilio(data.audioData);
                    break;
                    
                default:
                    log(`ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…: ${data.type}`, 'warning');
            }
        }

        // Ultravox ì—°ê²°
        function connectToUltravox(joinUrl) {
            log(`ğŸ¯ Ultravox ì—°ê²° ì‹œì‘: ${joinUrl}`, 'info');
            updateConnectionStatus('ultravox', false, 'ì—°ê²° ì¤‘...');
            
            ultravoxSocket = new WebSocket(joinUrl);
            
            ultravoxSocket.onopen = function() {
                log('âœ… Ultravox ì—°ê²° ì„±ê³µ', 'success');
                updateConnectionStatus('ultravox', true);
            };
            
            ultravoxSocket.onclose = function() {
                log('âŒ Ultravox ì—°ê²° ì¢…ë£Œ', 'error');
                updateConnectionStatus('ultravox', false);
            };
            
            ultravoxSocket.onmessage = function(event) {
                // Ultravox â†’ Pie Socketìœ¼ë¡œ ì˜¤ë””ì˜¤ ì „ë‹¬
                if (pieSocket && pieSocket.readyState === WebSocket.OPEN) {
                    pieSocket.send(JSON.stringify({
                        type: 'audio_from_ultravox',
                        audioData: event.data
                    }));
                }
            };
            
            ultravoxSocket.onerror = function(error) {
                log(`âŒ Ultravox ì—°ê²° ì˜¤ë¥˜: ${error}`, 'error');
                updateConnectionStatus('ultravox', false, 'ì˜¤ë¥˜ ë°œìƒ');
            };
        }

        // ì˜¤ë””ì˜¤ ì „ë‹¬ í•¨ìˆ˜ë“¤
        function forwardAudioToUltravox(audioData) {
            if (ultravoxSocket && ultravoxSocket.readyState === WebSocket.OPEN) {
                ultravoxSocket.send(audioData);
            }
        }

        function forwardAudioToTwilio(audioData) {
            if (twilioSocket && twilioSocket.readyState === WebSocket.OPEN) {
                twilioSocket.send(JSON.stringify({
                    event: 'media',
                    media: { payload: audioData }
                }));
            }
        }

        // URL íŒŒë¼ë¯¸í„° í™•ì¸
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const twilioStream = urlParams.get('twilio_stream');
            
            if (twilioStream === 'true') {
                log('ğŸ“ Twilio ìŠ¤íŠ¸ë¦¼ ëª¨ë“œë¡œ ì‹¤í–‰ë¨', 'info');
                updateConnectionStatus('twilio', true, 'ìŠ¤íŠ¸ë¦¼ ëª¨ë“œ');
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        elements.reconnectBtn.addEventListener('click', () => {
            log('ğŸ”„ ìˆ˜ë™ ì¬ì—°ê²° ì‹œì‘', 'info');
            initializePieSocket();
        });

        elements.clearLogBtn.addEventListener('click', () => {
            elements.logContainer.innerHTML = '';
            log('ğŸ§¹ ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤', 'info');
        });

        elements.testBtn.addEventListener('click', () => {
            if (pieSocket && pieSocket.readyState === WebSocket.OPEN) {
                pieSocket.send(JSON.stringify({
                    type: 'test_message',
                    timestamp: new Date().toISOString()
                }));
                log('ğŸ§ª í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ë¨', 'info');
            } else {
                log('âŒ Pie Socket ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            log('ğŸš€ ì›¹ì†Œì¼“ ë¸Œë¦¿ì§€ ì„œë²„ ì‹œì‘', 'success');
            checkUrlParameters();
            
            // ì„¤ì • ê²€ì¦ í›„ ì—°ê²° ì‹œì‘
            if (validateConfig()) {
                setTimeout(initializePieSocket, 1000);
            }
        });

        // í˜ì´ì§€ ë‹«ê¸° ì „ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (pieSocket) pieSocket.close();
            if (ultravoxSocket) ultravoxSocket.close();
            if (twilioSocket) twilioSocket.close();
        });
    </script>
</body>
</html>
